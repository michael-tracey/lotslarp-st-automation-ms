<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Influence Summary</title> <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            font-size: 13px;
            color: #212529;
        }
        .container {
            padding: 15px 25px;
        }
         h2 {
            color: #343a40;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
            margin-top: 10px;
            margin-bottom: 16px;
            font-weight: 500;
            font-size: 1.3em;
         }
         h3 { /* Level Header */
            color: #495057;
            background-color: #e9ecef;
            padding: 8px 12px;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 1.15em;
            border-radius: 4px;
         }
         h4 { /* Most/Least/Unused Used Header */
             margin-top: 20px;
             margin-bottom: 8px;
             font-size: 1.05em;
             font-weight: 500;
             color: #495057;
             border-top: 1px dashed #dee2e6;
             padding-top: 15px;
         }
         h3:first-of-type {
             margin-top: 0;
         }
        .month-section {
            margin-bottom: 25px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #fff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            padding-bottom: 15px;
        }
        .month-header {
            background-color: #495057;
            color: white;
            padding: 10px 15px;
            font-size: 1.2em;
            font-weight: 500;
        }
        .level-details-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 20px;
            padding: 10px 15px;
             border-bottom: 1px solid #e9ecef;
        }
         .month-section > div:last-of-type.level-details-container {
             border-bottom: none; /* Remove border from last level details */
         }

        .details-column {
            flex: 1;
            border-left: 3px solid #dee2e6;
            padding-left: 10px;
            margin-bottom: 10px;
        }
        .details-column.elite { border-left-color: #28a745; } /* Green */
        .details-column.underworld { border-left-color: #dc3545; } /* Red */

        .action-header {
             font-weight: 500;
             margin-bottom: 6px;
             color: #343a40;
             font-size: 1.05em;
        }
         .action-header .action-name {
             font-weight: 700;
             color: #0056b3;
             display: block;
             margin-bottom: 3px;
         }
         .action-header span.percentage {
             font-weight: 400;
             font-size: 0.9em;
             color: #6c757d;
         }
         ul.spec-list {
             list-style-type: none;
             padding-left: 15px;
             margin-top: 3px;
             margin-bottom: 5px;
             font-size: 0.95em;
         }
         ul.spec-list li {
             margin-bottom: 2px;
         }
         ul.spec-list li span {
             font-weight: 500;
             margin-left: 4px;
         }
         .no-action, .no-specs { /* Combined class */
             font-style: italic;
             color: #6c757d;
             font-size: 0.95em;
             margin-top: 5px;
             padding-left: 5px;
         }
         /* Summary Table */
         #summary-table {
             width: 100%; /* Make summary table wider */
             margin-bottom: 25px;
             border-collapse: collapse;
             background-color: #fff;
             box-shadow: 0 1px 3px rgba(0,0,0,0.1);
             border-radius: 6px;
             overflow: hidden;
         }
         #summary-table th, #summary-table td {
             text-align: center;
             padding: 8px 10px;
             border: 1px solid #dee2e6;
         }
          #summary-table th {
             background-color: #e9ecef;
             font-weight: 500;
             color: #495057;
         }
         #summary-table td:first-child {
             text-align: left;
             font-weight: 500;
             width: 25%; /* Allocate space for month */
         }
         #summary-table td {
             width: 18.75%; /* Divide remaining space */
         }
         .percent-change.positive { color: #28a745; }
         .percent-change.negative { color: #dc3545; }
         .percent-change.neutral { color: #6c757d; }

         /* Top/Bottom Spec Tables */
         .spec-summary-container {
             display: flex;
             gap: 20px;
             padding: 0 15px;
             flex-wrap: wrap;
         }
         .spec-summary-table {
             flex: 1;
             min-width: 250px;
             border-collapse: collapse;
             font-size: 0.95em;
             margin-bottom: 10px;
         }
         .spec-summary-table th, .spec-summary-table td {
             border: 1px solid #e9ecef;
             padding: 5px 8px;
             text-align: left;
         }
         .spec-summary-table th {
             background-color: #f8f9fa;
             font-weight: 500;
         }
         .spec-summary-table td:last-child {
             text-align: right;
             font-weight: 500;
             width: 50px;
         }
         /* Unused Specs List */
         .unused-specs-section {
             padding: 0 15px 10px 15px;
             margin-top: 10px; /* Add space above */
             border-top: 1px dashed #dee2e6; /* Separator */
             padding-top: 15px;
             display: flex; /* Layout side by side */
             gap: 20px;
             flex-wrap: wrap;
         }
         .unused-column {
             flex: 1;
             min-width: 200px;
         }
         .unused-column h4 { /* Header for unused */
             margin-top: 0;
             border-top: none;
             padding-top: 0;
             margin-bottom: 5px;
             font-size: 1.0em; /* Slightly smaller */
         }
         .unused-specs-list {
             font-size: 0.9em;
             color: #6c757d;
             column-count: 2; /* Display in columns */
             column-gap: 20px;
             padding-left: 15px; /* Indent list */
             margin-top: 0;
         }
         .unused-specs-list div {
             margin-bottom: 2px;
         }

    </style>
</head>
<body>
    <div class="container">

        <h2>Monthly Influence Totals</h2>
        <? /* Check if summary and monthTotals exist */ ?>
        <? if (summary && summary.monthTotals && summary.monthTotals.length > 0) { ?>
            <table id="summary-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Total Elite</th>
                        <th>% Change Elite</th>
                        <th>Total Underworld</th>
                        <th>% Change UW</th>
                    </tr>
                </thead>
                <tbody>
                    <? summary.monthTotals.forEach(month => { ?>
                        <tr>
                            <td><?= month.monthYear ?></td>
                            <td><?= month.eliteTotal ?></td>
                            <td class="percent-change <?= month.eliteChangePercent && month.eliteChangePercent.startsWith('+') ? 'positive' : (month.eliteChangePercent && month.eliteChangePercent.startsWith('-') ? 'negative' : 'neutral') ?>">
                                <?= month.eliteChangePercent ?>
                            </td>
                            <td><?= month.uwTotal ?></td>
                             <td class="percent-change <?= month.uwChangePercent && month.uwChangePercent.startsWith('+') ? 'positive' : (month.uwChangePercent && month.uwChangePercent.startsWith('-') ? 'negative' : 'neutral') ?>">
                                <?= month.uwChangePercent ?>
                             </td>
                        </tr>
                    <? }); ?>
                </tbody>
            </table>
        <? } else { ?>
             <p>No influence data found to summarize.</p>
        <? } ?>


        <? /* Sort months descending for display */ ?>
        <? const sortedMonths = summary && summary.details ? Object.keys(summary.details).sort((a, b) => new Date(b) - new Date(a)) : []; ?>

        <? if (sortedMonths.length === 0 && (!summary || !summary.monthTotals || summary.monthTotals.length === 0)) { ?>
            <? } ?>

        <? sortedMonths.forEach(monthYear => { ?>
            <div class="month-section">
                <div class="month-header"><?= monthYear ?></div>

                <? const monthDetails = summary.details[monthYear]; ?>
                <? if (monthDetails && monthDetails.levels && monthDetails.levels.length > 0) { ?>
                    <? monthDetails.levels.forEach(levelInfo => { ?>
                         <h3>Level <?= levelInfo.level === Infinity ? 'Misc' : levelInfo.level ?></h3> <? /* Display Misc for actions without number */ ?>
                         <div class="level-details-container">

                            <div class="details-column elite">
                                <? if (levelInfo.eliteAction) { ?>
                                    <div class="action-header">
                                        <span class="action-name"><?= levelInfo.eliteAction.name ?></span>
                                        <span class="percentage">(<?= levelInfo.eliteAction.percentage ?>% of month's Elite)</span>
                                    </div>
                                    <? if (levelInfo.eliteAction.specs && levelInfo.eliteAction.specs.length > 0) { ?>
                                        <ul class="spec-list">
                                            <? levelInfo.eliteAction.specs.forEach(spec => { ?>
                                                <li><?= spec.name ?>: <span><?= spec.count ?></span></li>
                                            <? }); ?>
                                        </ul>
                                     <? } else { ?>
                                         <p class="no-specs">No specific specializations recorded.</p>
                                     <? } ?>
                                <? } else { ?>
                                     <p class="no-action">No Elite Action at this level.</p>
                                <? } ?>
                            </div>

                            <div class="details-column underworld">
                                 <? if (levelInfo.uwAction) { ?>
                                     <div class="action-header">
                                        <span class="action-name"><?= levelInfo.uwAction.name ?></span>
                                        <span class="percentage">(<?= levelInfo.uwAction.percentage ?>% of month's UW)</span>
                                     </div>
                                     <? if (levelInfo.uwAction.specs && levelInfo.uwAction.specs.length > 0) { ?>
                                         <ul class="spec-list">
                                            <? levelInfo.uwAction.specs.forEach(spec => { ?>
                                                <li><?= spec.name ?>: <span><?= spec.count ?></span></li>
                                            <? }); ?>
                                        </ul>
                                     <? } else { ?>
                                         <p class="no-specs">No specific specializations recorded.</p>
                                     <? } ?>
                                <? } else { ?>
                                     <p class="no-action">No Underworld Action at this level.</p>
                                <? } ?>
                            </div>

                         </div> <? }); ?>

                     <h4>Monthly Specialization Usage</h4>
                     <div class="spec-summary-container">
                         <? if (monthDetails.mostUsed && monthDetails.mostUsed.length > 0) { ?>
                             <table class="spec-summary-table">
                                 <thead><tr><th>Most Used (Top <?= TOP_N_SPECS ?>)</th><th>Count</th></tr></thead>
                                 <tbody>
                                     <? monthDetails.mostUsed.forEach(spec => { ?>
                                         <tr><td><?= spec.name ?></td><td><?= spec.totalCount ?></td></tr>
                                     <? }); ?>
                                 </tbody>
                             </table>
                         <? } ?>
                         <? if (monthDetails.leastUsed && monthDetails.leastUsed.length > 0) { ?>
                              <table class="spec-summary-table">
                                 <thead><tr><th>Least Used (Top <?= TOP_N_SPECS ?> Used > 0)</th><th>Count</th></tr></thead>
                                 <tbody>
                                     <? monthDetails.leastUsed.forEach(spec => { ?>
                                         <tr><td><?= spec.name ?></td><td><?= spec.totalCount ?></td></tr>
                                     <? }); ?>
                                 </tbody>
                             </table>
                         <? } ?>
                     </div>
                      <? if ((monthDetails.unusedElite && monthDetails.unusedElite.length > 0) || (monthDetails.unusedUw && monthDetails.unusedUw.length > 0)) { ?>
                         <div class="unused-specs-section">
                             <div class="unused-column">
                                 <h4>Unused Elite Specializations</h4>
                                 <? if (monthDetails.unusedElite && monthDetails.unusedElite.length > 0) { ?>
                                     <div class="unused-specs-list">
                                         <? monthDetails.unusedElite.forEach(specName => { ?>
                                             <div><?= specName ?></div>
                                         <? }); ?>
                                     </div>
                                 <? } else { ?>
                                     <p class="no-action" style="padding-left: 15px;">None</p>
                                 <? } ?>
                             </div>
                             <div class="unused-column">
                                  <h4>Unused Underworld Specializations</h4>
                                 <? if (monthDetails.unusedUw && monthDetails.unusedUw.length > 0) { ?>
                                     <div class="unused-specs-list">
                                         <? monthDetails.unusedUw.forEach(specName => { ?>
                                             <div><?= specName ?></div>
                                         <? }); ?>
                                     </div>
                                 <? } else { ?>
                                     <p class="no-action" style="padding-left: 15px;">None</p>
                                 <? } ?>
                             </div>
                         </div>
                     <? } ?>


                <? } else { ?>
                     <div style="padding: 15px; font-style: italic; color: #6c757d;">No actions recorded for this month.</div>
                <? } ?>

            </div> <? }); ?>

    </div>
    </body>
</html>
